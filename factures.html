<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Devis & Factures â€” Saint Galmier Judo Club</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<!-- Google Identity Services pour Drive API -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

const firebaseConfig = {
  apiKey: "AIzaSyA5Hi_kXIDj6VJjdsDD_tXTCsHX_wfSyDs",
  authDomain: "judo-club-85c55.firebaseapp.com",
  projectId: "judo-club-85c55",
  storageBucket: "judo-club-85c55.firebasestorage.app",
  messagingSenderId: "981958072439",
  appId: "1:981958072439:web:f287415902ed28a6708e72"
};

const ALLOWED_EMAILS = [
  'chrisbellot257@gmail.com',
  'celinegrieco@gmail.com',
  'carinecarayol66@gmail.com'
];

// ID du dossier Google Drive partagÃ© SGJC â€” Devis & Factures
const DRIVE_FOLDER_ID = '1aFBuzx7CV6wumjyW1A2XDqTBmtjjt901';

// âœ… CORRECTION 1 : Client ID OAuth 2.0 correct
const GOOGLE_CLIENT_ID = '981958072439-haccr1at62iiek1kscf024bcjg6svos4.apps.googleusercontent.com';

const app  = initializeApp(firebaseConfig);
const db   = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();
// âœ… CORRECTION 2 : Demander le scope Drive dÃ¨s la connexion Firebase
provider.addScope('https://www.googleapis.com/auth/drive.file');

window.db = db;
window.fbFunctions = { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot };
window.DRIVE_FOLDER_ID = DRIVE_FOLDER_ID;
window.googleAccessToken = null;
window.gisTokenClient = null;

// â”€â”€ Mettre Ã  jour l'indicateur Drive dans le header â”€â”€â”€â”€â”€â”€
function updateDriveIndicator(state) {
  // state: 'connected' | 'pending' | 'disconnected'
  const icon = document.getElementById('drive-icon');
  const text = document.getElementById('drive-status-text');
  if (!icon || !text) return;
  if (state === 'connected') {
    icon.textContent = 'â˜ï¸';
    text.innerHTML = 'Drive<br><span style="font-size:0.65rem;color:#81C784">ConnectÃ© âœ…</span>';
  } else if (state === 'pending') {
    icon.textContent = 'â³';
    text.innerHTML = 'Drive<br><span style="font-size:0.65rem;opacity:0.7">Autorisation...</span>';
  } else {
    icon.textContent = 'âš ï¸';
    text.innerHTML = 'Drive<br><span style="font-size:0.65rem;color:#FFB74D">Non connectÃ©</span>';
  }
}

// â”€â”€ Initialiser Google Identity Services (token Drive) â”€â”€â”€
function initGIS() {
  if (!window.google?.accounts?.oauth2) {
    setTimeout(initGIS, 300);
    return;
  }
  window.gisTokenClient = window.google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/drive.file',
    // âœ… CORRECTION 3 : prompt vide = pas de popup si dÃ©jÃ  consentement donnÃ©
    prompt: '',
    callback: (tokenResponse) => {
      if (tokenResponse.error) {
        console.error('GIS token error:', tokenResponse.error);
        showToast('âŒ Erreur token Drive : ' + tokenResponse.error, 'error');
        updateDriveIndicator('disconnected');
        return;
      }
      window.googleAccessToken = tokenResponse.access_token;
      updateDriveIndicator('connected');
      console.log('âœ… Token Drive GIS obtenu');
      // Si un upload Ã©tait en attente, le relancer
      if (window._pendingUpload) {
        const { blob, filename } = window._pendingUpload;
        window._pendingUpload = null;
        window.uploadToDrive(blob, filename);
      }
    }
  });
  console.log('âœ… GIS initialisÃ© avec Client ID correct');
}

// Lancer GIS dÃ¨s que possible
document.addEventListener('DOMContentLoaded', () => setTimeout(initGIS, 500));

// â”€â”€ LOGIN Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.loginGoogle = async () => {
  try {
    const result = await signInWithPopup(auth, provider);
    const email  = result.user.email.toLowerCase();

    if (!ALLOWED_EMAILS.includes(email)) {
      await signOut(auth);
      window.googleAccessToken = null;
      document.getElementById('login-error').textContent = 'â›” AccÃ¨s non autorisÃ© pour ' + email;
      document.getElementById('login-error').style.display = 'block';
      return;
    }

    // âœ… CORRECTION 4 : Tenter de rÃ©cupÃ©rer le token via Firebase credential
    const credential = GoogleAuthProvider.credentialFromResult(result);
    if (credential?.accessToken) {
      window.googleAccessToken = credential.accessToken;
      console.log('âœ… Token Drive obtenu via Firebase popup');
      updateDriveIndicator('connected');
    } else {
      // âœ… CORRECTION 5 : Fallback GIS automatique si token Firebase absent
      console.warn('Token Firebase absent â€” demande automatique via GIS dans 1.5s...');
      updateDriveIndicator('pending');
      setTimeout(() => {
        if (window.gisTokenClient) {
          window.gisTokenClient.requestAccessToken();
        }
      }, 1500);
    }
  } catch(e) {
    document.getElementById('login-error').textContent = 'âš ï¸ Erreur : ' + e.message;
    document.getElementById('login-error').style.display = 'block';
  }
};

window.logoutGoogle = async () => {
  await signOut(auth);
  window.googleAccessToken = null;
  updateDriveIndicator('disconnected');
};

// â”€â”€ Demander manuellement le token Drive via GIS â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.requestDriveToken = (pendingBlob = null, pendingFilename = null) => {
  if (!window.gisTokenClient) {
    showToast('âš ï¸ Google non initialisÃ©, rÃ©essayez dans un instant', 'error');
    return;
  }
  if (pendingBlob) {
    window._pendingUpload = { blob: pendingBlob, filename: pendingFilename };
  }
  updateDriveIndicator('pending');
  // âœ… CORRECTION 6 : forcer le prompt consent pour obtenir un nouveau token
  window.gisTokenClient.requestAccessToken({ prompt: 'consent' });
};

// â”€â”€ AUTH STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthStateChanged(auth, (user) => {
  if (user && ALLOWED_EMAILS.includes(user.email.toLowerCase())) {
    document.getElementById('login-screen').style.display  = 'none';
    document.getElementById('app-content').style.display   = 'block';
    document.getElementById('user-name').textContent  = user.displayName || user.email;
    document.getElementById('user-email').textContent = user.email;
    if (user.photoURL) document.getElementById('user-avatar').src = user.photoURL;
    window.firebaseReady = true;
    window.dispatchEvent(new Event('firebaseReady'));
    // Mise Ã  jour indicateur selon token disponible
    setTimeout(() => {
      if (window.googleAccessToken) {
        updateDriveIndicator('connected');
      } else {
        updateDriveIndicator('disconnected');
      }
    }, 800);
  } else {
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('app-content').style.display  = 'none';
  }
});

// â”€â”€ UPLOAD VERS GOOGLE DRIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.uploadToDrive = async (pdfBlob, filename) => {
  // âœ… CORRECTION 7 : Token absent â†’ demander via GIS et mettre en attente
  if (!window.googleAccessToken) {
    showToast('ğŸ”‘ Autorisation Drive requise â€” une popup va s\'ouvrir...', 'success');
    window.requestDriveToken(pdfBlob, filename);
    return null;
  }

  try {
    showToast('â˜ï¸ Envoi vers Google Drive...', 'success');
    const metadata = {
      name: filename,
      parents: [DRIVE_FOLDER_ID],
      mimeType: 'application/pdf'
    };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', pdfBlob);

    const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink', {
      method: 'POST',
      headers: { Authorization: 'Bearer ' + window.googleAccessToken },
      body: form
    });

    // âœ… CORRECTION 8 : Token expirÃ© (401) â†’ re-demander via GIS automatiquement
    if (res.status === 401) {
      window.googleAccessToken = null;
      updateDriveIndicator('disconnected');
      showToast('ğŸ”‘ Token expirÃ© â€” re-autorisation Drive...', 'error');
      window.requestDriveToken(pdfBlob, filename);
      return null;
    }

    if (!res.ok) {
      const err = await res.json();
      const errMsg = err.error?.message || `HTTP ${res.status}`;
      showToast('âŒ Erreur Drive : ' + errMsg, 'error');
      console.error('Drive API error:', err);
      return null;
    }

    const data = await res.json();
    showToast('âœ… PDF sauvegardÃ© dans le Drive partagÃ© !', 'success');
    updateDriveIndicator('connected');
    console.log('âœ… Drive upload OK :', data.webViewLink);
    return data.id;
  } catch(e) {
    console.error('Drive upload network error:', e);
    showToast('âŒ Erreur rÃ©seau Drive', 'error');
    return null;
  }
};
</script>

<style>
:root {
  --rouge: #C41E2A;
  --rouge-dark: #8B1219;
  --or: #D4A017;
  --or-light: #F0C040;
  --noir: #0D1B2A;
  --bleu-club: #1A3A6B;
  --bleu-mid: #1E4FC2;
  --bleu-clair: #2E6DE6;
  --bleu-pale: #E8F0FE;
  --gris: #F4F6FB;
  --gris-mid: #D0D8E8;
  --blanc: #FFFFFF;
  --texte: #0D1B2A;
  --texte-light: #5A6A85;
  --vert: #2E7D32;
  --bleu: #1565C0;
  --shadow: 0 2px 12px rgba(13,27,42,0.08);
  --shadow-lg: 0 8px 32px rgba(13,27,42,0.18);
  --radius: 12px;
  --transition: all 0.2s ease;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--gris);
  color: var(--texte);
  min-height: 100vh;
}

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-header {
  background: linear-gradient(135deg, var(--bleu-club) 0%, var(--bleu-mid) 60%, var(--bleu-clair) 100%);
  color: white;
  padding: 0 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  height: 64px;
  box-shadow: 0 4px 20px rgba(26,58,107,0.4);
  position: sticky;
  top: 0;
  z-index: 100;
}

.app-header .logo-circle {
  width: 42px; height: 42px;
  background: rgba(255,255,255,0.15);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.1rem;
  letter-spacing: 0.5px;
  border: 1.5px solid rgba(255,255,255,0.3);
  flex-shrink: 0;
}

.app-header h1 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.5rem;
  letter-spacing: 2px;
  flex: 1;
}

.app-header .subtitle {
  font-size: 0.75rem;
  opacity: 0.7;
  letter-spacing: 1px;
  text-transform: uppercase;
}

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px 20px;
}

/* â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs {
  display: flex;
  gap: 4px;
  background: white;
  padding: 6px;
  border-radius: 14px;
  margin-bottom: 24px;
  box-shadow: var(--shadow);
  width: fit-content;
}

.tab-btn {
  padding: 10px 24px;
  border: none;
  background: transparent;
  border-radius: 10px;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  color: var(--texte-light);
  display: flex; align-items: center; gap: 8px;
}

.tab-btn.active {
  background: var(--bleu-club);
  color: white;
  box-shadow: 0 3px 10px rgba(26,58,107,0.3);
}

.tab-btn:hover:not(.active) { background: var(--gris); color: var(--texte); }

/* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 24px;
  margin-bottom: 20px;
}

.card-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.2rem;
  letter-spacing: 2px;
  color: var(--bleu-club);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 2px solid var(--gris);
  padding-bottom: 12px;
}

/* â”€â”€ FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.form-grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
.form-grid.cols-1 { grid-template-columns: 1fr; }

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.form-group.full { grid-column: 1 / -1; }

label {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--texte-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

label .required { color: var(--rouge); margin-left: 2px; }

input, select, textarea {
  padding: 11px 14px;
  border: 2px solid var(--gris-mid);
  border-radius: 8px;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.95rem;
  color: var(--texte);
  background: var(--gris);
  transition: var(--transition);
  outline: none;
}

input:focus, select:focus, textarea:focus {
  border-color: var(--bleu-mid);
  background: white;
  box-shadow: 0 0 0 3px rgba(30,79,194,0.12);
}

textarea { resize: vertical; min-height: 80px; }

/* â”€â”€ LIGNES TABLEAU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lignes-section {
  margin-top: 8px;
}

.ligne-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 12px;
}

.ligne-table th {
  background: var(--bleu-club);
  color: white;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  padding: 10px 12px;
  text-align: left;
}

.ligne-table th:first-child { border-radius: 8px 0 0 8px; }
.ligne-table th:last-child { border-radius: 0 8px 8px 0; }

.ligne-row td {
  padding: 6px 4px;
  vertical-align: middle;
  border-bottom: 1px solid var(--gris-mid);
}

.ligne-row td input, .ligne-row td select {
  width: 100%;
  padding: 8px 10px;
  font-size: 0.88rem;
  border-radius: 6px;
  background: var(--gris);
}

.ligne-row .montant-cell {
  font-family: 'DM Mono', monospace;
  font-size: 0.9rem;
  font-weight: 500;
  color: var(--bleu-club);
  text-align: right;
  padding-right: 8px;
  min-width: 90px;
}

.btn-delete-ligne {
  background: none;
  border: none;
  cursor: pointer;
  color: #ccc;
  font-size: 1.2rem;
  padding: 4px 8px;
  border-radius: 4px;
  transition: var(--transition);
}
.btn-delete-ligne:hover { color: var(--rouge); background: #fff0f0; }

.btn-add-ligne {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 18px;
  background: var(--gris);
  border: 2px dashed var(--gris-mid);
  border-radius: 8px;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.88rem;
  color: var(--texte-light);
  transition: var(--transition);
  width: 100%;
  justify-content: center;
}
.btn-add-ligne:hover { border-color: var(--rouge); color: var(--rouge); background: #fff5f5; }

/* â”€â”€ TOTAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.total-section {
  display: flex;
  justify-content: flex-end;
  margin-top: 16px;
}

.total-box {
  background: var(--bleu-club);
  color: white;
  border-radius: 10px;
  padding: 16px 24px;
  min-width: 260px;
}

.total-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  font-size: 0.9rem;
}

.total-row.final {
  border-top: 1px solid rgba(255,255,255,0.2);
  margin-top: 8px;
  padding-top: 10px;
  font-size: 1.1rem;
  font-weight: 700;
}

.total-row.final .amount {
  font-family: 'DM Mono', monospace;
  color: #FFD54F;
  font-size: 1.3rem;
}

/* â”€â”€ BOUTONS ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: flex-end;
  margin-top: 24px;
  padding-top: 20px;
  border-top: 2px solid var(--gris);
}

.btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 22px;
  border: none;
  border-radius: 10px;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  text-decoration: none;
}

.btn-primary {
  background: var(--bleu-club);
  color: white;
  box-shadow: 0 4px 14px rgba(26,58,107,0.35);
}
.btn-primary:hover { background: #122d52; transform: translateY(-1px); }

.btn-secondary {
  background: var(--gris);
  color: var(--texte);
  border: 2px solid var(--gris-mid);
}
.btn-secondary:hover { background: var(--gris-mid); }

.btn-success {
  background: var(--vert);
  color: white;
  box-shadow: 0 4px 14px rgba(46,125,50,0.3);
}
.btn-success:hover { background: #1B5E20; transform: translateY(-1px); }

.btn-info {
  background: var(--bleu);
  color: white;
  box-shadow: 0 4px 14px rgba(21,101,192,0.3);
}
.btn-info:hover { background: #0D47A1; }

.btn-gold {
  background: var(--or);
  color: white;
  box-shadow: 0 4px 14px rgba(212,160,23,0.35);
}
.btn-gold:hover { background: #B8860B; transform: translateY(-1px); }

/* â”€â”€ DRIVE CONNECT BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-drive {
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.4);
  color: white;
  padding: 4px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.7rem;
  font-weight: 600;
  transition: var(--transition);
  display: block;
  margin-top: 2px;
}
.btn-drive:hover { background: rgba(255,255,255,0.3); }

/* â”€â”€ LISTE DES DOCS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.doc-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 16px;
}

.doc-card {
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 20px;
  border-left: 5px solid var(--gris-mid);
  transition: var(--transition);
  cursor: pointer;
}

.doc-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }

.doc-card.devis { border-left-color: var(--bleu-clair); }
.doc-card.facture { border-left-color: var(--vert); }
.doc-card.facture-impayee { border-left-color: var(--rouge); }

.doc-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}

.doc-numero {
  font-family: 'DM Mono', monospace;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--texte-light);
  text-transform: uppercase;
}

.doc-badge {
  padding: 3px 10px;
  border-radius: 20px;
  font-size: 0.72rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.badge-devis { background: #E3F2FD; color: var(--bleu); }
.badge-facture { background: #E8F5E9; color: var(--vert); }
.badge-impayee { background: #FFEBEE; color: var(--rouge); }

.doc-client {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 4px;
}

.doc-objet {
  font-size: 0.83rem;
  color: var(--texte-light);
  margin-bottom: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.doc-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.doc-montant {
  font-family: 'DM Mono', monospace;
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--rouge-dark);
}

.doc-date {
  font-size: 0.78rem;
  color: var(--texte-light);
}

.doc-actions {
  display: flex;
  gap: 6px;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--gris);
}

.btn-sm {
  padding: 6px 12px;
  font-size: 0.78rem;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-family: 'DM Sans', sans-serif;
  font-weight: 600;
  transition: var(--transition);
  display: flex; align-items: center; gap: 4px;
}

.btn-sm-pdf { background: #FFEBEE; color: var(--rouge); }
.btn-sm-pdf:hover { background: var(--rouge); color: white; }
.btn-sm-edit { background: var(--gris); color: var(--texte); }
.btn-sm-edit:hover { background: var(--gris-mid); }
.btn-sm-conv { background: #E8F5E9; color: var(--vert); }
.btn-sm-conv:hover { background: var(--vert); color: white; }
.btn-sm-del { background: #FFEBEE; color: var(--rouge); margin-left: auto; }
.btn-sm-del:hover { background: var(--rouge); color: white; }

/* â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-bar {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: white;
  border-radius: var(--radius);
  padding: 18px 20px;
  box-shadow: var(--shadow);
  text-align: center;
  border-top: 4px solid var(--gris-mid);
}

.stat-card.rouge { border-top-color: var(--bleu-club); }
.stat-card.vert { border-top-color: var(--vert); }
.stat-card.bleu { border-top-color: var(--bleu-mid); }
.stat-card.or { border-top-color: var(--or); }

.stat-value {
  font-family: 'DM Mono', monospace;
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--texte);
}

.stat-label {
  font-size: 0.75rem;
  color: var(--texte-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 4px;
}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: var(--noir);
  color: white;
  padding: 14px 20px;
  border-radius: 10px;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: var(--shadow-lg);
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  z-index: 999;
  max-width: 360px;
}

.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { border-left: 4px solid var(--vert); }
.toast.error { border-left: 4px solid var(--rouge); }

/* â”€â”€ VIDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--texte-light);
}

.empty-state .icon { font-size: 3rem; margin-bottom: 12px; }
.empty-state p { font-size: 1rem; }

/* â”€â”€ SECTION TITLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}

.section-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.8rem;
  letter-spacing: 3px;
  color: var(--noir);
}

/* â”€â”€ FILTRE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filter-bar {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  align-items: center;
}

.filter-bar input {
  flex: 1;
  min-width: 200px;
  background: white;
}

.filter-bar select { width: 160px; background: white; }

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 768px) {
  .form-grid { grid-template-columns: 1fr; }
  .form-grid.cols-3 { grid-template-columns: 1fr 1fr; }
  .stats-bar { grid-template-columns: 1fr 1fr; }
  .ligne-table { font-size: 0.82rem; }
  .tabs { width: 100%; justify-content: center; }
  .actions { justify-content: center; }
}

/* â”€â”€ HIDDEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hidden { display: none !important; }

/* â”€â”€ NUMÃ‰RO AUTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.num-preview {
  font-family: 'DM Mono', monospace;
  font-size: 0.85rem;
  color: var(--texte-light);
  background: var(--gris);
  padding: 4px 10px;
  border-radius: 6px;
  display: inline-block;
  margin-top: 4px;
}

/* â”€â”€ SEPARATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sep { height: 1px; background: var(--gris-mid); margin: 20px 0; }

/* â”€â”€ SPINNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.spinner {
  display: inline-block;
  width: 18px; height: 18px;
  border: 2px solid rgba(255,255,255,0.4);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- Ã‰CRAN DE CONNEXION                                       -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen" style="
  display:flex; align-items:center; justify-content:center;
  min-height:100vh; background:linear-gradient(135deg,#0D1B2A 0%,#1A3A6B 50%,#1E4FC2 100%);
">
  <div style="
    background:white; border-radius:20px; padding:48px 40px;
    text-align:center; max-width:380px; width:90%;
    box-shadow:0 20px 60px rgba(0,0,0,0.4);
  ">
    <div style="
      width:70px;height:70px;background:linear-gradient(135deg,#1A3A6B,#1E4FC2);
      border-radius:50%;display:flex;align-items:center;justify-content:center;
      margin:0 auto 20px;font-size:2rem;box-shadow:0 6px 20px rgba(26,58,107,0.4);
    ">ğŸ¥‹</div>
    <div style="font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:3px;color:#1A1A1A;margin-bottom:4px;">
      DEVIS & FACTURES
    </div>
    <div style="font-size:0.8rem;color:#888;margin-bottom:32px;text-transform:uppercase;letter-spacing:1px;">
      Saint Galmier Judo Club
    </div>
    <button onclick="loginGoogle()" style="
      display:flex;align-items:center;justify-content:center;gap:12px;
      width:100%;padding:14px 20px;background:#fff;border:2px solid #E0DDD8;
      border-radius:12px;cursor:pointer;font-family:'DM Sans',sans-serif;
      font-size:0.95rem;font-weight:600;color:#2C2C2C;
      transition:all 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.08);
    " onmouseover="this.style.borderColor='#C41E2A';this.style.boxShadow='0 4px 16px rgba(196,30,42,0.2)'"
       onmouseout="this.style.borderColor='#E0DDD8';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)'">
      <img src="https://www.google.com/favicon.ico" width="20" height="20" alt="Google">
      Se connecter avec Google
    </button>
    <div id="login-error" style="
      display:none;margin-top:16px;padding:10px 14px;
      background:#FFEBEE;color:#C41E2A;border-radius:8px;
      font-size:0.82rem;font-weight:500;
    "></div>
    <div style="margin-top:20px;font-size:0.75rem;color:#bbb;">
      AccÃ¨s rÃ©servÃ© aux membres du bureau SGJC
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- APP (visible aprÃ¨s connexion)                           -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app-content" style="display:none">

<header class="app-header">
  <div class="logo-circle">ğŸ¥‹</div>
  <div style="flex:1">
    <h1>Devis & Factures</h1>
    <div class="subtitle">Saint Galmier Judo Club</div>
  </div>
  <!-- User info + logout -->
  <div style="display:flex;align-items:center;gap:10px;">
    <img id="user-avatar" src="" width="32" height="32" style="border-radius:50%;border:2px solid rgba(255,255,255,0.4);display:block" onerror="this.style.display='none'">
    <div style="text-align:right;line-height:1.3">
      <div id="user-name" style="font-size:0.82rem;font-weight:600;color:white"></div>
      <div id="user-email" style="font-size:0.7rem;opacity:0.6;color:white"></div>
    </div>
    <button onclick="logoutGoogle()" style="
      background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);
      color:white;padding:6px 12px;border-radius:8px;cursor:pointer;
      font-family:'DM Sans',sans-serif;font-size:0.78rem;font-weight:500;
      transition:all 0.2s;
    " onmouseover="this.style.background='rgba(255,255,255,0.25)'"
       onmouseout="this.style.background='rgba(255,255,255,0.15)'">
      DÃ©connexion
    </button>
  </div>

  <!-- Indicateur Drive + bouton connexion manuelle -->
  <div style="
    display:flex;align-items:center;gap:6px;margin-left:12px;
    background:rgba(255,255,255,0.12);border-radius:8px;padding:6px 10px;
    font-size:0.72rem;color:white;opacity:0.9;
  ">
    <span id="drive-icon">â³</span>
    <div>
      <span id="drive-status-text">Drive<br><span style="font-size:0.65rem;opacity:0.7">Initialisation...</span></span>
      <!-- âœ… CORRECTION 9 : Bouton pour connecter Drive manuellement -->
      <button class="btn-drive" onclick="window.requestDriveToken()" title="Connecter Google Drive">
        ğŸ”‘ Connecter Drive
      </button>
    </div>
  </div>
</header>

<div class="container">

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('liste')" id="tab-liste">
      ğŸ“‹ Mes documents
    </button>
    <button class="tab-btn" onclick="switchTab('nouveau')" id="tab-nouveau">
      âœï¸ Nouveau document
    </button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- VUE LISTE                                              -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="vue-liste">

    <!-- Stats -->
    <div class="stats-bar">
      <div class="stat-card rouge">
        <div class="stat-value" id="stat-total-docs">â€”</div>
        <div class="stat-label">Documents</div>
      </div>
      <div class="stat-card bleu">
        <div class="stat-value" id="stat-devis">â€”</div>
        <div class="stat-label">Devis en cours</div>
      </div>
      <div class="stat-card vert">
        <div class="stat-value" id="stat-factures">â€”</div>
        <div class="stat-label">Factures payÃ©es</div>
      </div>
      <div class="stat-card or">
        <div class="stat-value" id="stat-montant">â€”</div>
        <div class="stat-label">Total encaissÃ© (â‚¬)</div>
      </div>
    </div>

    <!-- Header + filtre -->
    <div class="section-header">
      <div class="section-title">ğŸ“‚ Documents</div>
      <button class="btn btn-primary" onclick="switchTab('nouveau'); resetForm()">
        âœï¸ Nouveau
      </button>
    </div>

    <div class="filter-bar">
      <input type="text" id="search-input" placeholder="ğŸ” Rechercher (client, numÃ©ro, objet...)" oninput="renderListe()">
      <select id="filter-type" onchange="renderListe()">
        <option value="">Tous les types</option>
        <option value="devis">Devis uniquement</option>
        <option value="facture">Factures uniquement</option>
      </select>
      <select id="filter-statut" onchange="renderListe()">
        <option value="">Tous les statuts</option>
        <option value="en_cours">En cours / EnvoyÃ©</option>
        <option value="accepte">AcceptÃ©</option>
        <option value="paye">PayÃ©</option>
        <option value="impaye">ImpayÃ©</option>
      </select>
    </div>

    <div id="doc-grid" class="doc-grid">
      <div class="empty-state">
        <div class="icon">ğŸ“„</div>
        <p>Chargement des documents...</p>
      </div>
    </div>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- VUE NOUVEAU / Ã‰DITION                                  -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="vue-nouveau" class="hidden">

    <!-- TYPE + NUMÃ‰RO -->
    <div class="card">
      <div class="card-title">ğŸ“„ Type de document</div>
      <div class="form-grid cols-3">
        <div class="form-group">
          <label>Type <span class="required">*</span></label>
          <select id="doc-type" onchange="updateNumero()">
            <option value="devis">Devis</option>
            <option value="facture">Facture</option>
          </select>
        </div>
        <div class="form-group">
          <label>NumÃ©ro (auto)</label>
          <div class="num-preview" id="num-preview">GÃ©nÃ©rÃ© automatiquement</div>
        </div>
        <div class="form-group">
          <label>Date du document <span class="required">*</span></label>
          <input type="date" id="doc-date">
        </div>
        <div class="form-group">
          <label>Date d'Ã©chÃ©ance / validitÃ©</label>
          <input type="date" id="doc-echeance">
        </div>
        <div class="form-group">
          <label>Statut</label>
          <select id="doc-statut">
            <option value="en_cours">En cours / EnvoyÃ©</option>
            <option value="accepte">AcceptÃ©</option>
            <option value="paye">PayÃ© âœ…</option>
            <option value="impaye">ImpayÃ© âš ï¸</option>
          </select>
        </div>
        <div class="form-group">
          <label>RÃ©fÃ©rence interne (facultatif)</label>
          <input type="text" id="doc-ref" placeholder="Ex : Tournoi 2026, Achat matÃ©riel...">
        </div>
      </div>
    </div>

    <!-- CLIENT / FOURNISSEUR -->
    <div class="card">
      <div class="card-title">ğŸ¢ Client / Fournisseur</div>
      <div class="form-grid">
        <div class="form-group">
          <label>Nom / Raison sociale <span class="required">*</span></label>
          <input type="text" id="client-nom" placeholder="Ex : Mairie de Saint-Galmier">
        </div>
        <div class="form-group">
          <label>Contact (nom de la personne)</label>
          <input type="text" id="client-contact" placeholder="Ex : M. Dupont">
        </div>
        <div class="form-group full">
          <label>Adresse</label>
          <input type="text" id="client-adresse" placeholder="NumÃ©ro et nom de rue">
        </div>
        <div class="form-group">
          <label>Code postal</label>
          <input type="text" id="client-cp" placeholder="42XXX">
        </div>
        <div class="form-group">
          <label>Ville</label>
          <input type="text" id="client-ville" placeholder="Ville">
        </div>
        <div class="form-group">
          <label>TÃ©lÃ©phone</label>
          <input type="tel" id="client-tel" placeholder="06 XX XX XX XX">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="client-email" placeholder="contact@exemple.fr">
        </div>
        <div class="form-group">
          <label>NÂ° SIRET (si pro)</label>
          <input type="text" id="client-siret" placeholder="Facultatif">
        </div>
        <div class="form-group">
          <label>NÂ° TVA intracommunautaire</label>
          <input type="text" id="client-tva" placeholder="Facultatif">
        </div>
      </div>
    </div>

    <!-- OBJET -->
    <div class="card">
      <div class="card-title">ğŸ“ Objet de la prestation</div>
      <div class="form-grid cols-1">
        <div class="form-group">
          <label>Objet / DÃ©signation gÃ©nÃ©rale <span class="required">*</span></label>
          <input type="text" id="doc-objet" placeholder="Ex : Fourniture de matÃ©riel sportif, Prestation animation judo, Location salle...">
        </div>
        <div class="form-group">
          <label>Description / Informations complÃ©mentaires</label>
          <textarea id="doc-description" placeholder="DÃ©tails supplÃ©mentaires, conditions particuliÃ¨res..."></textarea>
        </div>
      </div>
    </div>

    <!-- LIGNES -->
    <div class="card">
      <div class="card-title">ğŸ§¾ DÃ©tail des prestations / fournitures</div>
      <div class="lignes-section">
        <table class="ligne-table">
          <thead>
            <tr>
              <th style="width:35%">DÃ©signation</th>
              <th style="width:12%">QtÃ© / Heures</th>
              <th style="width:12%">UnitÃ©</th>
              <th style="width:14%">Prix unitaire (â‚¬)</th>
              <th style="width:14%">Montant (â‚¬)</th>
              <th style="width:6%"></th>
            </tr>
          </thead>
          <tbody id="lignes-tbody"></tbody>
        </table>
        <button class="btn-add-ligne" onclick="addLigne()">
          â• Ajouter une ligne
        </button>
      </div>

      <!-- Total -->
      <div class="total-section">
        <div class="total-box">
          <div class="total-row">
            <span>Sous-total HT</span>
            <span id="total-ht" style="font-family:'DM Mono',monospace">0,00 â‚¬</span>
          </div>
          <div class="total-row" style="opacity:0.6;font-size:0.8rem">
            <span>TVA (association â€” non applicable)</span>
            <span>0,00 â‚¬</span>
          </div>
          <div class="total-row final">
            <span>TOTAL TTC</span>
            <span class="amount" id="total-ttc">0,00 â‚¬</span>
          </div>
        </div>
      </div>
    </div>

    <!-- NOTES / CONDITIONS -->
    <div class="card">
      <div class="card-title">ğŸ“‹ Conditions & Mentions</div>
      <div class="form-grid cols-1">
        <div class="form-group">
          <label>Notes / Conditions de rÃ¨glement</label>
          <textarea id="doc-notes" placeholder="Ex : RÃ¨glement Ã  30 jours, par virement bancaire...">RÃ¨glement Ã  rÃ©ception de la facture par virement bancaire ou chÃ¨que Ã  l'ordre de Saint Galmier Judo Club.</textarea>
        </div>
        <div class="form-group">
          <label>Mode de paiement acceptÃ©</label>
          <select id="doc-paiement">
            <option value="Virement bancaire ou chÃ¨que">Virement bancaire ou chÃ¨que</option>
            <option value="Virement bancaire">Virement bancaire uniquement</option>
            <option value="ChÃ¨que">ChÃ¨que uniquement</option>
            <option value="EspÃ¨ces">EspÃ¨ces</option>
            <option value="Tout moyen">Tout moyen de paiement</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ACTIONS -->
    <div class="actions">
      <button class="btn btn-secondary" onclick="switchTab('liste')">
        â† Annuler
      </button>
      <button class="btn btn-primary" onclick="saveDocument()" id="btn-save">
        ğŸ’¾ Enregistrer
      </button>
      <button class="btn btn-gold" onclick="previewAndExportPDF()" id="btn-pdf">
        ğŸ“„ GÃ©nÃ©rer le PDF
      </button>
    </div>

  </div>

</div><!-- /container -->
</div><!-- /app-content -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ã‰TAT DE L'APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let documents = [];
let editingId = null;
let ligneCounter = 0;
let firebaseDB = null;

// Attendre Firebase
window.addEventListener('firebaseReady', () => {
  firebaseDB = window.db;
  loadDocuments();
});

// Fallback si Firebase pas dispo dans 3s
setTimeout(() => {
  if (!firebaseDB) {
    showToast('âš ï¸ Mode hors-ligne â€” Firebase non disponible', 'error');
    renderListe();
    updateStats();
  }
}, 3000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  document.getElementById('vue-liste').classList.toggle('hidden', tab !== 'liste');
  document.getElementById('vue-nouveau').classList.toggle('hidden', tab !== 'nouveau');
  document.getElementById('tab-liste').classList.toggle('active', tab === 'liste');
  document.getElementById('tab-nouveau').classList.toggle('active', tab === 'nouveau');

  if (tab === 'nouveau' && !editingId) {
    initNewDoc();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDocuments() {
  try {
    const { collection, query, orderBy, onSnapshot } = window.fbFunctions;
    const q = query(collection(firebaseDB, 'factures'), orderBy('createdAt', 'desc'));

    onSnapshot(q, (snapshot) => {
      documents = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      renderListe();
      updateStats();
    });
  } catch(e) {
    console.error('Firebase error:', e);
    showToast('Erreur de chargement', 'error');
  }
}

async function saveToFirebase(docData) {
  const { collection, addDoc, doc, updateDoc } = window.fbFunctions;
  if (editingId) {
    await updateDoc(doc(firebaseDB, 'factures', editingId), { ...docData, updatedAt: new Date().toISOString() });
    showToast('âœ… Document mis Ã  jour !', 'success');
  } else {
    await addDoc(collection(firebaseDB, 'factures'), { ...docData, createdAt: new Date().toISOString() });
    showToast('âœ… Document enregistrÃ© !', 'success');
  }
}

async function deleteDocument(id) {
  if (!confirm('Supprimer ce document dÃ©finitivement ?')) return;
  const { doc, deleteDoc } = window.fbFunctions;
  await deleteDoc(doc(firebaseDB, 'factures', id));
  showToast('ğŸ—‘ï¸ Document supprimÃ©', 'success');
}

async function convertToFacture(id) {
  if (!confirm('Convertir ce devis en facture ?')) return;
  const { doc, updateDoc } = window.fbFunctions;
  const numero = genNumero('facture');
  await updateDoc(doc(firebaseDB, 'factures', id), {
    type: 'facture',
    numero,
    statut: 'en_cours',
    updatedAt: new Date().toISOString()
  });
  showToast('âœ… Devis converti en facture !', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NUMÃ‰ROTATION AUTOMATIQUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genNumero(type) {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const prefix = type === 'devis' ? 'DEV' : 'FAC';
  const existing = documents.filter(d => d.type === type && d.numero?.startsWith(`${prefix}-${year}`));
  const seq = String(existing.length + 1).padStart(3, '0');
  return `${prefix}-${year}${month}-${seq}`;
}

function updateNumero() {
  const type = document.getElementById('doc-type').value;
  const num = editingId ? '(conservÃ©)' : genNumero(type);
  document.getElementById('num-preview').textContent = num;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIGNES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addLigne(data = {}) {
  ligneCounter++;
  const id = 'ligne_' + ligneCounter;
  const tbody = document.getElementById('lignes-tbody');
  const tr = document.createElement('tr');
  tr.className = 'ligne-row';
  tr.id = id;
  tr.innerHTML = `
    <td><input type="text" placeholder="DÃ©signation de la prestation ou fourniture" 
       value="${data.designation || ''}" oninput="calcTotal()"></td>
    <td><input type="number" placeholder="1" min="0" step="0.01" 
       value="${data.qte || 1}" oninput="calcTotal()" style="text-align:right"></td>
    <td>
      <select onchange="calcTotal()">
        <option value="forfait" ${data.unite === 'forfait' ? 'selected' : ''}>Forfait</option>
        <option value="heure" ${data.unite === 'heure' ? 'selected' : ''}>Heure</option>
        <option value="jour" ${data.unite === 'jour' ? 'selected' : ''}>Jour</option>
        <option value="piÃ¨ce" ${data.unite === 'piÃ¨ce' ? 'selected' : ''}>PiÃ¨ce</option>
        <option value="mÂ²" ${data.unite === 'mÂ²' ? 'selected' : ''}>mÂ²</option>
        <option value="km" ${data.unite === 'km' ? 'selected' : ''}>km</option>
        <option value="lot" ${data.unite === 'lot' ? 'selected' : ''}>Lot</option>
      </select>
    </td>
    <td><input type="number" placeholder="0.00" min="0" step="0.01" 
       value="${data.pu || ''}" oninput="calcTotal()" style="text-align:right"></td>
    <td class="montant-cell" id="mt_${id}">0,00 â‚¬</td>
    <td><button class="btn-delete-ligne" onclick="deleteLigne('${id}')" title="Supprimer">âœ•</button></td>
  `;
  tbody.appendChild(tr);
  calcTotal();
}

function deleteLigne(id) {
  document.getElementById(id)?.remove();
  calcTotal();
}

function getLignes() {
  const rows = document.querySelectorAll('.ligne-row');
  return Array.from(rows).map(row => {
    const inputs = row.querySelectorAll('input');
    const sel = row.querySelector('select');
    const qte = parseFloat(inputs[1].value) || 0;
    const pu = parseFloat(inputs[2].value) || 0;
    return {
      designation: inputs[0].value,
      qte,
      unite: sel.value,
      pu,
      montant: qte * pu
    };
  });
}

function calcTotal() {
  const rows = document.querySelectorAll('.ligne-row');
  let total = 0;
  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    const qte = parseFloat(inputs[1].value) || 0;
    const pu = parseFloat(inputs[2].value) || 0;
    const mt = qte * pu;
    total += mt;
    const id = row.id;
    const cell = document.getElementById('mt_' + id);
    if (cell) cell.textContent = formatMoney(mt);
  });
  document.getElementById('total-ht').textContent = formatMoney(total);
  document.getElementById('total-ttc').textContent = formatMoney(total);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT / RESET FORMULAIRE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initNewDoc() {
  resetForm();
  const today = new Date();
  document.getElementById('doc-date').value = today.toISOString().split('T')[0];
  const echeance = new Date(today.getTime() + 30 * 24 * 3600 * 1000);
  document.getElementById('doc-echeance').value = echeance.toISOString().split('T')[0];
  updateNumero();
  addLigne();
  addLigne();
}

function resetForm() {
  editingId = null;
  ligneCounter = 0;
  document.getElementById('lignes-tbody').innerHTML = '';
  ['doc-type','doc-date','doc-echeance','doc-statut','doc-ref',
   'client-nom','client-contact','client-adresse','client-cp','client-ville',
   'client-tel','client-email','client-siret','client-tva',
   'doc-objet','doc-description','doc-notes'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = el.tagName === 'SELECT' ? el.options[0].value : '';
  });
  document.getElementById('doc-notes').value = 'RÃ¨glement Ã  rÃ©ception de la facture par virement bancaire ou chÃ¨que Ã  l\'ordre de Saint Galmier Judo Club.';
  document.getElementById('doc-paiement').value = 'Virement bancaire ou chÃ¨que';
  document.getElementById('btn-save').innerHTML = 'ğŸ’¾ Enregistrer';
  calcTotal();
  updateNumero();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAUVEGARDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveDocument() {
  const nom = document.getElementById('client-nom').value.trim();
  const objet = document.getElementById('doc-objet').value.trim();
  const date = document.getElementById('doc-date').value;

  if (!nom || !objet || !date) {
    showToast('âš ï¸ Remplissez : nom du client, objet et date', 'error');
    return;
  }

  const btn = document.getElementById('btn-save');
  btn.innerHTML = '<span class="spinner"></span> Enregistrement...';
  btn.disabled = true;

  const type = document.getElementById('doc-type').value;
  const lignes = getLignes();
  const total = lignes.reduce((s, l) => s + l.montant, 0);

  const docData = {
    type,
    numero: editingId ? documents.find(d => d.id === editingId)?.numero : genNumero(type),
    statut: document.getElementById('doc-statut').value,
    date,
    echeance: document.getElementById('doc-echeance').value,
    ref: document.getElementById('doc-ref').value,
    client: {
      nom, contact: document.getElementById('client-contact').value,
      adresse: document.getElementById('client-adresse').value,
      cp: document.getElementById('client-cp').value,
      ville: document.getElementById('client-ville').value,
      tel: document.getElementById('client-tel').value,
      email: document.getElementById('client-email').value,
      siret: document.getElementById('client-siret').value,
      tva: document.getElementById('client-tva').value,
    },
    objet,
    description: document.getElementById('doc-description').value,
    notes: document.getElementById('doc-notes').value,
    paiement: document.getElementById('doc-paiement').value,
    lignes,
    total
  };

  try {
    await saveToFirebase(docData);
    btn.disabled = false;
    btn.innerHTML = 'ğŸ’¾ Enregistrer';
    switchTab('liste');
  } catch(e) {
    btn.disabled = false;
    btn.innerHTML = 'ğŸ’¾ Enregistrer';
    showToast('âŒ Erreur d\'enregistrement', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ã‰DITION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function editDocument(id) {
  const d = documents.find(x => x.id === id);
  if (!d) return;
  editingId = id;
  switchTab('nouveau');
  resetForm();

  document.getElementById('doc-type').value = d.type;
  document.getElementById('num-preview').textContent = d.numero;
  document.getElementById('doc-date').value = d.date;
  document.getElementById('doc-echeance').value = d.echeance || '';
  document.getElementById('doc-statut').value = d.statut;
  document.getElementById('doc-ref').value = d.ref || '';
  document.getElementById('client-nom').value = d.client?.nom || '';
  document.getElementById('client-contact').value = d.client?.contact || '';
  document.getElementById('client-adresse').value = d.client?.adresse || '';
  document.getElementById('client-cp').value = d.client?.cp || '';
  document.getElementById('client-ville').value = d.client?.ville || '';
  document.getElementById('client-tel').value = d.client?.tel || '';
  document.getElementById('client-email').value = d.client?.email || '';
  document.getElementById('client-siret').value = d.client?.siret || '';
  document.getElementById('client-tva').value = d.client?.tva || '';
  document.getElementById('doc-objet').value = d.objet || '';
  document.getElementById('doc-description').value = d.description || '';
  document.getElementById('doc-notes').value = d.notes || '';
  document.getElementById('doc-paiement').value = d.paiement || 'Virement bancaire ou chÃ¨que';

  document.getElementById('lignes-tbody').innerHTML = '';
  (d.lignes || []).forEach(l => addLigne(l));

  document.getElementById('btn-save').innerHTML = 'ğŸ’¾ Mettre Ã  jour';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GÃ‰NÃ‰RATION PDF PROFESSIONNELLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function previewAndExportPDF(docId = null) {
  let d = null;

  if (docId) {
    d = documents.find(x => x.id === docId);
  } else {
    const type = document.getElementById('doc-type').value;
    const lignes = getLignes();
    const total = lignes.reduce((s, l) => s + l.montant, 0);
    const existingNum = editingId ? documents.find(x => x.id === editingId)?.numero : genNumero(type);
    d = {
      type,
      numero: existingNum,
      statut: document.getElementById('doc-statut').value,
      date: document.getElementById('doc-date').value,
      echeance: document.getElementById('doc-echeance').value,
      ref: document.getElementById('doc-ref').value,
      client: {
        nom: document.getElementById('client-nom').value,
        contact: document.getElementById('client-contact').value,
        adresse: document.getElementById('client-adresse').value,
        cp: document.getElementById('client-cp').value,
        ville: document.getElementById('client-ville').value,
        tel: document.getElementById('client-tel').value,
        email: document.getElementById('client-email').value,
        siret: document.getElementById('client-siret').value,
        tva: document.getElementById('client-tva').value,
      },
      objet: document.getElementById('doc-objet').value,
      description: document.getElementById('doc-description').value,
      notes: document.getElementById('doc-notes').value,
      paiement: document.getElementById('doc-paiement').value,
      lignes,
      total
    };
  }

  generatePDF(d);
}

function generatePDF(d) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

  const isDevis = d.type === 'devis';
  const W = 210, H = 297;
  const ML = 15, MR = 15, MT = 15;

  const BLEU_MARINE  = [13,  27,  66];
  const BLEU_MID     = [26,  79, 194];
  const BLEU_CLAIR   = [232, 240, 254];
  const BLEU_TITRE   = [30,  79, 194];
  const BLANC        = [255, 255, 255];
  const GRIS_CLAIR   = [245, 247, 252];
  const GRIS_MID     = [180, 190, 210];
  const OR           = [212, 160, 23];
  const TEXTE        = [13,  27,  42];
  const VERT         = [46,  125, 50];
  const ACCENT = isDevis ? BLEU_MID : VERT;
  const NOIR = BLEU_MARINE;
  const ROUGE = BLEU_MARINE;
  const BLEU = BLEU_MID;

  pdf.setFillColor(...BLEU_MARINE);
  pdf.rect(0, 0, W, 32, 'F');

  pdf.setFillColor(255, 255, 255, 40);
  pdf.setDrawColor(255,255,255);
  pdf.setLineWidth(0.5);
  pdf.circle(ML + 10, 16, 10, 'D');
  pdf.setFontSize(10);
  pdf.setTextColor(255, 255, 255);
  pdf.setFont('helvetica', 'bold');
  pdf.text('SGJC', ML + 10, 17.5, { align: 'center' });

  pdf.setFontSize(22);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(255, 255, 255);
  pdf.text(isDevis ? 'DEVIS' : 'FACTURE', ML + 25, 14);
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'normal');
  pdf.text(`NÂ° ${d.numero || 'â€”'}`, ML + 25, 21);
  pdf.text(`Date : ${formatDate(d.date)}`, ML + 25, 27);

  const statutLabel = { en_cours: 'EN COURS', accepte: 'ACCEPTÃ‰', paye: 'PAYÃ‰', impaye: 'IMPAYÃ‰' };
  const statutColor = { en_cours: [100,149,237], accepte: [46,125,50], paye: [46,125,50], impaye: [196,30,42] };
  pdf.setFillColor(...(statutColor[d.statut] || [100,100,100]));
  pdf.roundedRect(W - MR - 32, 9, 32, 10, 2, 2, 'F');
  pdf.setFontSize(7);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(255, 255, 255);
  pdf.text(statutLabel[d.statut] || d.statut.toUpperCase(), W - MR - 16, 15.5, { align: 'center' });

  let y = 42;

  const colW = 84;

  pdf.setFillColor(...GRIS_CLAIR);
  pdf.roundedRect(ML, y, colW, 46, 2, 2, 'F');
  pdf.setFontSize(7);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...ROUGE);
  pdf.text('Ã‰METTEUR', ML + 4, y + 6);
  pdf.setTextColor(...NOIR);
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'bold');
  pdf.text('Saint Galmier Judo Club', ML + 4, y + 13);
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(8);
  pdf.text('82 A Chemin des Ã‰cureuils', ML + 4, y + 19);
  pdf.text('42210 BELLEGARDE EN FOREZ', ML + 4, y + 24);
  pdf.text('Email : sgjudo@sfr.fr', ML + 4, y + 30);
  pdf.text('www.saintgalmierjudoclub.fr', ML + 4, y + 35);
  pdf.setFont('helvetica', 'bold');
  pdf.text('SIRET : 80238941100017', ML + 4, y + 41);

  const destX = ML + colW + 10;
  pdf.setFillColor(...GRIS_CLAIR);
  pdf.roundedRect(destX, y, colW, 46, 2, 2, 'F');
  pdf.setFontSize(7);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...ACCENT);
  pdf.text(isDevis ? 'DESTINATAIRE' : 'FACTURÃ‰ Ã€', destX + 4, y + 6);
  pdf.setTextColor(...NOIR);
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'bold');
  pdf.text(d.client?.nom || 'â€”', destX + 4, y + 13);
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(8);
  let dy = y + 19;
  if (d.client?.contact) { pdf.text(d.client.contact, destX + 4, dy); dy += 5; }
  if (d.client?.adresse) { pdf.text(d.client.adresse, destX + 4, dy); dy += 5; }
  if (d.client?.cp || d.client?.ville) {
    pdf.text(`${d.client.cp || ''} ${d.client.ville || ''}`.trim(), destX + 4, dy); dy += 5;
  }
  if (d.client?.tel) { pdf.text(`TÃ©l : ${d.client.tel}`, destX + 4, dy); dy += 5; }
  if (d.client?.email) { pdf.text(`Email : ${d.client.email}`, destX + 4, dy); dy += 5; }
  if (d.client?.siret) { pdf.text(`SIRET : ${d.client.siret}`, destX + 4, dy); dy += 5; }

  y += 54;

  pdf.setFillColor(...NOIR);
  pdf.roundedRect(ML, y, W - ML - MR, 10, 2, 2, 'F');
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(255, 255, 255);
  pdf.text(`Objet : ${d.objet || 'â€”'}`, ML + 4, y + 7);

  const dateText = isDevis
    ? `ValiditÃ© : ${formatDate(d.echeance)}`
    : `Ã‰chÃ©ance : ${formatDate(d.echeance)}`;
  pdf.text(dateText, W - MR - 4, y + 7, { align: 'right' });

  y += 16;

  if (d.ref) {
    pdf.setFontSize(7);
    pdf.setFont('helvetica', 'italic');
    pdf.setTextColor(...GRIS_MID);
    pdf.text(`RÃ©f. interne : ${d.ref}`, ML, y);
    y += 6;
  }

  if (d.description) {
    pdf.setFontSize(8);
    pdf.setFont('helvetica', 'normal');
    pdf.setTextColor(...NOIR);
    const descLines = pdf.splitTextToSize(d.description, W - ML - MR);
    pdf.text(descLines, ML, y);
    y += descLines.length * 5 + 4;
  }

  const tableData = (d.lignes || []).map(l => [
    l.designation || 'â€”',
    formatNum(l.qte),
    l.unite || 'forfait',
    formatMoney(l.pu),
    formatMoney(l.montant)
  ]);

  pdf.autoTable({
    startY: y,
    head: [['DÃ©signation', 'QtÃ©', 'UnitÃ©', 'Prix unitaire HT', 'Montant HT']],
    body: tableData,
    margin: { left: ML, right: MR },
    styles: { fontSize: 8.5, cellPadding: 3, font: 'helvetica' },
    headStyles: {
      fillColor: BLEU_TITRE,
      textColor: [255, 255, 255],
      fontStyle: 'bold',
      fontSize: 8
    },
    alternateRowStyles: { fillColor: BLEU_CLAIR },
    columnStyles: {
      0: { cellWidth: 'auto' },
      1: { cellWidth: 18, halign: 'center' },
      2: { cellWidth: 20, halign: 'center' },
      3: { cellWidth: 32, halign: 'right' },
      4: { cellWidth: 32, halign: 'right', fontStyle: 'bold' }
    },
    didDrawPage: () => {}
  });

  y = pdf.lastAutoTable.finalY + 6;

  const totalBoxX = W - MR - 70;
  pdf.setFillColor(...GRIS_CLAIR);
  pdf.roundedRect(totalBoxX, y, 70, 26, 2, 2, 'F');
  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...NOIR);
  pdf.text('Sous-total HT :', totalBoxX + 4, y + 7);
  pdf.setFont('helvetica', 'bold');
  pdf.text(formatMoney(d.total || 0), W - MR - 4, y + 7, { align: 'right' });
  pdf.setFont('helvetica', 'normal');
  pdf.setFontSize(7);
  pdf.setTextColor(...GRIS_MID);
  pdf.text('TVA : Non applicable â€” Association loi 1901', totalBoxX + 4, y + 13);
  pdf.setDrawColor(...NOIR);
  pdf.setLineWidth(0.3);
  pdf.line(totalBoxX + 3, y + 16, totalBoxX + 67, y + 16);
  pdf.setFillColor(...NOIR);
  pdf.roundedRect(totalBoxX, y + 17, 70, 9, 2, 2, 'F');
  pdf.setFontSize(9);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(255, 255, 255);
  pdf.text('TOTAL TTC :', totalBoxX + 4, y + 23);
  pdf.setTextColor(...[212, 160, 23]);
  pdf.text(formatMoney(d.total || 0), W - MR - 4, y + 23, { align: 'right' });

  y += 34;

  if (y > H - 65) { pdf.addPage(); y = 20; }

  pdf.setFillColor(...GRIS_CLAIR);
  pdf.roundedRect(ML, y, W - ML - MR, 10, 2, 2, 'F');
  pdf.setFontSize(7.5);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...ACCENT);
  pdf.text('CONDITIONS DE PAIEMENT', ML + 4, y + 7);
  y += 13;

  pdf.setFontSize(8);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(...NOIR);
  if (d.notes) {
    const noteLines = pdf.splitTextToSize(d.notes, W - ML - MR);
    pdf.text(noteLines, ML, y);
    y += noteLines.length * 5 + 3;
  }
  pdf.text(`Mode de paiement acceptÃ© : ${d.paiement || 'â€”'}`, ML, y);
  y += 8;

  if (isDevis && y < H - 60) {
    pdf.setFillColor(...GRIS_CLAIR);
    pdf.roundedRect(ML, y, (W - ML - MR) / 2 - 4, 30, 2, 2, 'F');
    pdf.setFontSize(7);
    pdf.setFont('helvetica', 'bold');
    pdf.setTextColor(...ACCENT);
    pdf.text('BON POUR ACCORD â€” Signature du client', ML + 4, y + 6);
    pdf.setTextColor(...GRIS_MID);
    pdf.setFont('helvetica', 'italic');
    pdf.text('(Date, signature et cachet Ã©ventuel)', ML + 4, y + 11);
    y += 36;
  }

  if (y > H - 40) { pdf.addPage(); y = 20; }

  pdf.setFillColor(...BLEU_MARINE);
  pdf.rect(0, H - 26, W, 1, 'F');
  pdf.setFillColor(...GRIS_CLAIR);
  pdf.rect(0, H - 25, W, 25, 'F');
  pdf.setFontSize(6.5);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...BLEU_MARINE);
  pdf.text('MENTIONS LÃ‰GALES', ML, H - 19);
  pdf.setFont('helvetica', 'normal');
  pdf.setTextColor(80, 80, 80);
  const mentions = 'Tout incident de paiement est passible d\'intÃ©rÃªt de retard. Le montant des pÃ©nalitÃ©s rÃ©sulte de l\'application aux sommes restant dues d\'un taux d\'intÃ©rÃªt lÃ©gal en vigueur au moment de l\'incident. IndemnitÃ© forfaitaire pour frais de recouvrement due au crÃ©ancier en cas de retard de paiement : 40â‚¬';
  const mentionLines = pdf.splitTextToSize(mentions, W - ML - MR);
  pdf.text(mentionLines, ML, H - 14);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(...BLEU_MARINE);
  pdf.text('Association Loi 1901 â€” W421002343 â€” PrÃ©fecture de Montbrison â€” SIRET : 80238941100017 â€” CatÃ©gorie juridique 9220 â€” www.saintgalmierjudoclub.fr â€” sgjudo@sfr.fr', ML, H - 4, { maxWidth: W - ML - MR });

  pdf.setFontSize(7);
  pdf.setTextColor(150, 150, 150);
  pdf.setFont('helvetica', 'normal');

  const filename = `${d.type?.toUpperCase()}_${d.numero || 'NOUVEAU'}_${d.client?.nom?.replace(/\s+/g, '_') || 'CLIENT'}.pdf`;

  // 1. TÃ©lÃ©chargement local immÃ©diat
  pdf.save(filename);
  showToast(`ğŸ“„ PDF tÃ©lÃ©chargÃ© â€” envoi Drive en cours...`, 'success');

  // 2. Upload Drive avec dÃ©lai pour laisser le save() se terminer
  setTimeout(async () => {
    try {
      const pdfBlob = pdf.output('blob');
      await window.uploadToDrive(pdfBlob, filename);
    } catch(e) {
      console.error('Drive upload error:', e);
      showToast('âŒ Erreur lors de l\'envoi Drive', 'error');
    }
  }, 800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDU LISTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderListe() {
  const search = document.getElementById('search-input')?.value.toLowerCase() || '';
  const filterType = document.getElementById('filter-type')?.value || '';
  const filterStatut = document.getElementById('filter-statut')?.value || '';

  let filtered = documents.filter(d => {
    const matchSearch = !search ||
      d.client?.nom?.toLowerCase().includes(search) ||
      d.numero?.toLowerCase().includes(search) ||
      d.objet?.toLowerCase().includes(search);
    const matchType = !filterType || d.type === filterType;
    const matchStatut = !filterStatut || d.statut === filterStatut;
    return matchSearch && matchType && matchStatut;
  });

  const grid = document.getElementById('doc-grid');
  if (!grid) return;

  if (filtered.length === 0) {
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1">
      <div class="icon">ğŸ“„</div>
      <p>${documents.length === 0 ? 'Aucun document â€” CrÃ©ez votre premier devis ou facture !' : 'Aucun rÃ©sultat pour cette recherche'}</p>
    </div>`;
    return;
  }

  const statutLabel = { en_cours: 'En cours', accepte: 'AcceptÃ©', paye: 'PayÃ©', impaye: 'ImpayÃ©' };

  grid.innerHTML = filtered.map(d => {
    const isImpaye = d.type === 'facture' && d.statut === 'impaye';
    const cardClass = isImpaye ? 'facture-impayee' : d.type;
    const badge = isImpaye ? 'badge-impayee' : (d.type === 'devis' ? 'badge-devis' : 'badge-facture');
    const badgeText = isImpaye ? 'âš ï¸ ImpayÃ©' : (d.type === 'devis' ? 'ğŸ“‹ Devis' : 'âœ… Facture');

    return `<div class="doc-card ${cardClass}">
      <div class="doc-card-header">
        <div class="doc-numero">${d.numero || 'â€”'}</div>
        <span class="doc-badge ${badge}">${badgeText}</span>
      </div>
      <div class="doc-client">${d.client?.nom || 'â€”'}</div>
      <div class="doc-objet">${d.objet || 'Sans objet'}</div>
      <div class="doc-footer">
        <div class="doc-montant">${formatMoney(d.total || 0)}</div>
        <div class="doc-date">
          ${formatDate(d.date)}<br>
          <span style="font-size:0.7rem">${statutLabel[d.statut] || d.statut}</span>
        </div>
      </div>
      <div class="doc-actions">
        <button class="btn-sm btn-sm-pdf" onclick="previewAndExportPDF('${d.id}')">ğŸ“„ PDF</button>
        <button class="btn-sm btn-sm-edit" onclick="editDocument('${d.id}')">âœï¸ Modifier</button>
        ${d.type === 'devis' ? `<button class="btn-sm btn-sm-conv" onclick="convertToFacture('${d.id}')">ğŸ”„ â†’ Facture</button>` : ''}
        <button class="btn-sm btn-sm-del" onclick="deleteDocument('${d.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  const total = documents.length;
  const devis = documents.filter(d => d.type === 'devis').length;
  const facPayees = documents.filter(d => d.type === 'facture' && d.statut === 'paye').length;
  const montant = documents
    .filter(d => d.type === 'facture' && d.statut === 'paye')
    .reduce((s, d) => s + (d.total || 0), 0);

  document.getElementById('stat-total-docs').textContent = total;
  document.getElementById('stat-devis').textContent = devis;
  document.getElementById('stat-factures').textContent = facPayees;
  document.getElementById('stat-montant').textContent = formatMoney(montant).replace(' â‚¬', '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITAIRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatMoney(n) {
  return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(n || 0);
}

function formatNum(n) {
  return n % 1 === 0 ? n.toString() : n.toFixed(2);
}

function formatDate(s) {
  if (!s) return 'â€”';
  const [y, m, d] = s.split('-');
  return `${d}/${m}/${y}`;
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  updateNumero();
});
</script>
</body>
</html>
